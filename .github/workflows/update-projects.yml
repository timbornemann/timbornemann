name: Update Projects List
on:
  schedule:
    - cron: "0 0 * * *"  # Täglich um Mitternacht
  workflow_dispatch:      # Manuell startbar

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Repo List
        uses: actions/github-script@v7
        id: script
        with:
          script: |
            const username = context.repo.owner;
            
            // 1. Repos holen (Maximal 100, sortiert nach Update)
            const repos = await github.paginate(github.rest.repos.listForUser, {
              username: username,
              sort: 'updated',
              direction: 'desc',
              per_page: 100,
              type: 'owner' // Nur eigene Repos, keine Forks (falls gewollt)
            });

            // 2. Filtern: Keine Forks, keine archivierten, und NICHT das Profil-Repo selbst
            const filteredRepos = repos
              .filter(r => !r.fork && !r.archived && r.name !== username)
              .slice(0, 20); // Nimm die Top 20

            // 3. Markdown Liste bauen
            let markdownContent = "";
            
            for (const repo of filteredRepos) {
              const description = repo.description ? ` - ${repo.description}` : "";
              // Format: - [Name](Link) - Beschreibung
              // Alternativ für Fettdruck: ` - **[${repo.name}](${repo.html_url})**${description}`
              markdownContent += `- [**${repo.name}**](${repo.html_url})${description}\n`;
            }

            // 4. In die README schreiben
            const fs = require('fs');
            const readmePath = 'README.md';
            const readme = fs.readFileSync(readmePath, 'utf8');
            
            const startTag = '';
            const endTag = '';
            
            const startIndex = readme.indexOf(startTag);
            const endIndex = readme.indexOf(endTag);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const newReadme = readme.slice(0, startIndex + startTag.length) + 
                                "\n" + markdownContent + 
                                readme.slice(endIndex);
              fs.writeFileSync(readmePath, newReadme);
            } else {
              console.log("Platzhalter nicht gefunden!");
            }

      - name: Commit & Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          # Nur committen, wenn sich was geändert hat
          git commit -m "Update project list" || exit 0
          git push
